---
phase: 06-product-enrichment-api-web
plan: "02"
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified:
  - packages/frontend/src/components/ProductDetailsModal.tsx
  - packages/frontend/src/components/ProductsView.tsx
  - packages/frontend/src/services/api.ts
autonomous: true
requirements:
  - PROD-01
  - PROD-03

must_haves:
  truths:
    - "ProductDetailsModal has a sale section with sale_type Select ('percent' or 'exact') and sale_price Input"
    - "Brand can save a sale (sale_type + sale_price) via the edit product modal and it persists to API"
    - "ProductsView product list shows a sale badge when sale_price is not null"
    - "ProductsView has a 'Remove sale' button per product that sends sale_price=null, sale_type=null to API"
    - "After removing sale the badge disappears and the button is gone for that product"
  artifacts:
    - path: packages/frontend/src/components/ProductDetailsModal.tsx
      provides: "sale section with Select + Input + state wired to updateProduct"
    - path: packages/frontend/src/components/ProductsView.tsx
      provides: "sale badge + remove sale button per product row"
    - path: packages/frontend/src/services/api.ts
      provides: "ProductResponse with sale_price, sale_type fields"
  key_links:
    - from: packages/frontend/src/components/ProductDetailsModal.tsx
      to: packages/frontend/src/services/api.ts updateProduct
      via: "handleSave passes sale_price and sale_type in updateProduct payload"
      pattern: "sale_price.*sale_type"
    - from: packages/frontend/src/components/ProductsView.tsx
      to: packages/frontend/src/services/api.ts updateProduct
      via: "remove sale handler calls updateProduct with sale_price: null, sale_type: null"
      pattern: "sale_price.*null"
---

<objective>
Add sale price UI to the web portal: a sale section in ProductDetailsModal for setting sale type and amount; a sale badge and remove-sale button in the ProductsView product list.

Purpose: Implements PROD-01 (set sale) and PROD-03 (remove sale) from the brand portal.
Output: Sale section in modal, sale badge + remove button in list.
</objective>

<execution_context>
@/Users/goldp1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/goldp1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/frontend/src/services/api.ts
@packages/frontend/src/components/ProductDetailsModal.tsx
@packages/frontend/src/components/ProductsView.tsx
@.planning/phases/06-product-enrichment-api-web/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sale_price/sale_type to ProductResponse and updateProduct in api.ts</name>
  <files>packages/frontend/src/services/api.ts</files>
  <action>
**In `ProductResponse` interface** (around line 129), add after `general_images`:
```typescript
delivery_time_min?: number;
delivery_time_max?: number;
sale_price?: number | null;
sale_type?: 'percent' | 'exact' | null;
sizing_table_image?: string | null;
```

**In `updateProduct` function** (around line 362), the `productData` parameter is an inline object type. Add the new optional fields to that type:
```typescript
sale_price?: number | null;
sale_type?: 'percent' | 'exact' | null;
sizing_table_image?: string | null;
delivery_time_min?: number | null;
delivery_time_max?: number | null;
```

Use `| null` (not just `?`) because the frontend needs to send explicit `null` to clear a sale — `undefined` would be omitted by JSON.stringify while `null` is included.

Verify TypeScript compiles:
```bash
cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20
```
  </action>
  <verify>cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20</verify>
  <done>TypeScript compiles with no errors; ProductResponse has sale_price, sale_type, sizing_table_image fields</done>
</task>

<task type="auto">
  <name>Task 2: Add sale section to ProductDetailsModal</name>
  <files>packages/frontend/src/components/ProductDetailsModal.tsx</files>
  <action>
Add a sale section to `ProductDetailsModal`. The modal currently has two columns inside `grid grid-cols-1 md:grid-cols-2 gap-8`. Add the sale section as a new full-width section below the two-column grid (before the `flex justify-end` buttons row).

**State additions** (after the existing state declarations around line 60):
```typescript
const [saleType, setSaleType] = useState<'percent' | 'exact' | ''>(
  product.sale_type || ''
);
const [salePrice, setSalePrice] = useState<string>(
  product.sale_price != null ? String(product.sale_price) : ''
);
```

**Reset on product change** (in the `useEffect([product])` around line 78, add):
```typescript
setSaleType(product.sale_type || '');
setSalePrice(product.sale_price != null ? String(product.sale_price) : '');
```

**Include in handleSave** (in the `api.updateProduct(...)` call around line 231, add to the payload):
```typescript
sale_price: salePrice !== '' ? parseFloat(salePrice) : null,
sale_type: saleType !== '' ? saleType : null,
```

**UI section** — add after the closing `</div>` of the two-column grid and before the `flex justify-end` buttons:
```tsx
{/* Sale section */}
<div className="border border-border/30 rounded-lg p-4 space-y-3">
  <h3 className="font-medium text-sm">Скидка</h3>
  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <Label>Тип скидки</Label>
      <Select
        value={saleType}
        onValueChange={(v) => setSaleType(v as 'percent' | 'exact' | '')}
      >
        <SelectTrigger className="mt-1">
          <SelectValue placeholder="Без скидки" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">Без скидки</SelectItem>
          <SelectItem value="percent">Процент (%)</SelectItem>
          <SelectItem value="exact">Фиксированная цена (₽)</SelectItem>
        </SelectContent>
      </Select>
    </div>
    {saleType !== '' && (
      <div>
        <Label>
          {saleType === 'percent' ? 'Скидка (%)' : 'Цена со скидкой (₽)'}
        </Label>
        <Input
          type="number"
          min={saleType === 'percent' ? 1 : 0}
          max={saleType === 'percent' ? 99 : undefined}
          placeholder={saleType === 'percent' ? 'напр., 20' : 'напр., 1990'}
          className="mt-1"
          value={salePrice}
          onChange={(e) => setSalePrice(e.target.value)}
        />
        {saleType === 'percent' && (
          <p className="text-xs text-muted-foreground mt-1">
            Покупатели увидят цену {salePrice ? Math.round(product.price * (1 - parseFloat(salePrice) / 100)) : '—'} ₽
          </p>
        )}
      </div>
    )}
  </div>
</div>
```

Note: when `saleType` is set to empty string `''`, send `sale_type: null` and `sale_price: null` in the payload so the sale is cleared via the save button too. The existing `Select` component from `@/components/ui/select` is already imported.
  </action>
  <verify>cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20</verify>
  <done>
- TypeScript compiles clean
- Modal has a sale section with type selector and conditional price input
- handleSave payload includes sale_price and sale_type
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sale badge and remove-sale button to ProductsView</name>
  <files>packages/frontend/src/components/ProductsView.tsx</files>
  <action>
In `ProductsView.tsx`, add a remove-sale handler and update the product row rendering.

**Handler** (after `handleProductUpdated`, around line 68):
```typescript
const handleRemoveSale = async (
  e: React.MouseEvent,
  product: api.ProductResponse
) => {
  e.stopPropagation(); // prevent row click from opening modal
  if (!token) return;
  try {
    await api.updateProduct(product.id, { sale_price: null, sale_type: null }, token);
    fetchProducts(token);
    toast({ title: 'Скидка удалена' });
  } catch {
    toast({
      title: 'Ошибка',
      description: 'Не удалось удалить скидку.',
      variant: 'destructive',
    });
  }
};
```

**In the product row JSX** (the `<div className="flex items-center justify-between p-2 ...">` around line 99), update the right side — currently just the price `<p>`. Wrap the price and add a sale badge and remove button:

```tsx
<div className="flex flex-col items-end gap-1">
  {product.sale_price != null && (
    <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded-full">
      {product.sale_type === 'percent'
        ? `-${product.sale_price}%`
        : `${formatCurrency(product.sale_price)}`}
    </span>
  )}
  <p className="font-bold text-foreground">{formatCurrency(product.price)}</p>
  {product.sale_price != null && (
    <button
      className="text-xs text-muted-foreground hover:text-destructive underline"
      onClick={(e) => handleRemoveSale(e, product)}
    >
      Убрать скидку
    </button>
  )}
</div>
```

No new imports needed — `formatCurrency` and `useToast` are already imported.
  </action>
  <verify>cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20</verify>
  <done>
- TypeScript compiles clean
- Product rows show a red badge when sale_price is set
- "Убрать скидку" button appears only when sale is active
- Clicking remove sale sends updateProduct with null fields and refreshes the list
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit
```
Expect: 0 errors.

Manual test with API running:
1. Open Products tab in brand portal
2. Click a product → modal opens → find "Скидка" section at bottom
3. Select "Процент (%)", enter 20 → see calculated price preview → save → success toast
4. Product row now shows "-20%" red badge and "Убрать скидку" link
5. Click "Убрать скидку" → badge and link disappear
</verification>

<success_criteria>
1. TypeScript compiles clean.
2. ProductDetailsModal has a sale section: type selector + conditional price input.
3. Saving with sale_type='percent' and sale_price=20 sends `{sale_price: 20, sale_type: 'percent'}` to API.
4. Saving with empty sale_type sends `{sale_price: null, sale_type: null}` (clears sale).
5. ProductsView shows sale badge and remove button when `sale_price != null`.
6. Remove sale button sends `{sale_price: null, sale_type: null}` and refreshes list.
</success_criteria>

<output>
After completion, create `.planning/phases/06-product-enrichment-api-web/06-02-SUMMARY.md` summarizing the sale UI implementation, state variable names, and how null-sending for sale clearing works.
</output>
