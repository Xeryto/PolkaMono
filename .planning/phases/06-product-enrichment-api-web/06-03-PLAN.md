---
phase: 06-product-enrichment-api-web
plan: "03"
type: execute
wave: 3
depends_on:
  - "06-02"
files_modified:
  - packages/frontend/src/components/ProductDetailsModal.tsx
autonomous: true
requirements:
  - PROD-04
  - PROD-06

must_haves:
  truths:
    - "ProductDetailsModal has a sizing table image section where brand can upload an image via S3 presigned URL"
    - "Uploaded sizing table image URL is sent in updateProduct payload as sizing_table_image"
    - "Existing sizing table image is shown as a thumbnail with a remove button"
    - "ProductDetailsModal has delivery time min and max Select dropdowns (same options as AddNewItemPage)"
    - "Delivery time override is sent in updateProduct payload; empty selection sends null to clear the override"
  artifacts:
    - path: packages/frontend/src/components/ProductDetailsModal.tsx
      provides: "sizing table upload section + delivery time selects wired to updateProduct"
  key_links:
    - from: packages/frontend/src/components/ProductDetailsModal.tsx
      to: packages/frontend/src/services/api.ts getProductImagePresignedUrl
      via: "sizing table file upload using same uploadOne pattern as general images"
      pattern: "getProductImagePresignedUrl"
    - from: packages/frontend/src/components/ProductDetailsModal.tsx
      to: packages/frontend/src/services/api.ts updateProduct
      via: "handleSave passes sizing_table_image, delivery_time_min, delivery_time_max"
      pattern: "sizing_table_image"
---

<objective>
Add sizing table image upload and per-product delivery time override to ProductDetailsModal. Both features reuse existing patterns (S3 presigned URL upload from the general images section; DELIVERY_TIME_OPTIONS from AddNewItemPage).

Purpose: Completes PROD-04 (sizing table) and PROD-06 (per-product delivery override) for the web portal.
Output: Two new sections in ProductDetailsModal wired to updateProduct.
</objective>

<execution_context>
@/Users/goldp1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/goldp1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/frontend/src/components/ProductDetailsModal.tsx
@packages/frontend/src/services/api.ts
@packages/frontend/src/pages/AddNewItemPage.tsx
@.planning/phases/06-product-enrichment-api-web/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sizing table image upload section to ProductDetailsModal</name>
  <files>packages/frontend/src/components/ProductDetailsModal.tsx</files>
  <action>
The modal already uploads product images using `api.getProductImagePresignedUrl` + `api.uploadFileToPresignedUrl`. Reuse the same `uploadOne` helper for the sizing table image.

**State additions** (after the salePrice/saleType state from Plan 02):
```typescript
const [sizingTableImage, setSizingTableImage] = useState<string | null>(
  product.sizing_table_image ?? null
);
const [sizingTableFile, setSizingTableFile] = useState<File | null>(null);
```

**Reset on product change** (in `useEffect([product])`):
```typescript
setSizingTableImage(product.sizing_table_image ?? null);
setSizingTableFile(null);
```

**In handleSave**, before the `api.updateProduct(...)` call, upload the new file if present (reuse the `uploadOne` already defined in the function):
```typescript
let finalSizingTableImage = sizingTableImage?.startsWith('http')
  ? sizingTableImage
  : null;
if (sizingTableFile) {
  finalSizingTableImage = await uploadOne(sizingTableFile);
}
```

Then include in the `api.updateProduct(...)` payload:
```typescript
sizing_table_image: finalSizingTableImage,
```

**UI section** — add a "Таблица размеров" section inside the modal. Place it in the second column of the existing grid (right column, after the general images section). Use `FileInput` (already imported) with `accept="image/*"` and `multiple={false}`:

```tsx
{/* Sizing table image */}
<div className="space-y-2">
  <Label>Таблица размеров</Label>
  <p className="text-xs text-muted-foreground">Изображение с таблицей размеров для покупателей</p>
  <FileInput
    accept="image/*"
    onFilesChange={(files) => {
      if (files[0]) {
        setSizingTableFile(files[0]);
        setSizingTableImage(URL.createObjectURL(files[0]));
      }
    }}
    selectedFileNames={sizingTableFile ? [sizingTableFile.name] : []}
    className="mt-1"
  />
  {sizingTableImage && (
    <div className="relative mt-2 inline-block">
      <img
        src={sizingTableImage}
        alt="Таблица размеров"
        className="h-24 object-contain rounded-md border border-border/30"
      />
      <button
        type="button"
        className="absolute -top-2 -right-2 h-4 w-4 text-red-500"
        onClick={() => {
          setSizingTableImage(null);
          setSizingTableFile(null);
        }}
      >
        <XCircle className="h-4 w-4" />
      </button>
    </div>
  )}
</div>
```

`XCircle` and `FileInput` are already imported in the modal.
  </action>
  <verify>cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20</verify>
  <done>
- TypeScript compiles clean
- Modal has a sizing table upload section with FileInput + thumbnail preview + remove button
- finalSizingTableImage is included in updateProduct payload
  </done>
</task>

<task type="auto">
  <name>Task 2: Add delivery time override selects to ProductDetailsModal</name>
  <files>packages/frontend/src/components/ProductDetailsModal.tsx</files>
  <action>
Reuse the `DELIVERY_TIME_OPTIONS` constant from `AddNewItemPage.tsx`. Do NOT import it from there — copy the same const locally at the top of `ProductDetailsModal.tsx` (after imports):

```typescript
const DELIVERY_TIME_OPTIONS = [
  { label: '1 день', value: 1 },
  { label: '2 дня', value: 2 },
  { label: '3 дня', value: 3 },
  { label: '5 дней', value: 5 },
  { label: '1 неделя', value: 7 },
  { label: '2 недели', value: 14 },
  { label: '3 недели', value: 21 },
  { label: '1 месяц', value: 30 },
];
```

**State additions** (after sizingTableFile state):
```typescript
const [deliveryTimeMin, setDeliveryTimeMin] = useState<string>(
  product.delivery_time_min != null ? String(product.delivery_time_min) : ''
);
const [deliveryTimeMax, setDeliveryTimeMax] = useState<string>(
  product.delivery_time_max != null ? String(product.delivery_time_max) : ''
);
```

**Reset on product change** (in `useEffect([product])`):
```typescript
setDeliveryTimeMin(product.delivery_time_min != null ? String(product.delivery_time_min) : '');
setDeliveryTimeMax(product.delivery_time_max != null ? String(product.delivery_time_max) : '');
```

**In handleSave**, include in the `api.updateProduct(...)` payload:
```typescript
delivery_time_min: deliveryTimeMin !== '' ? parseInt(deliveryTimeMin) : null,
delivery_time_max: deliveryTimeMax !== '' ? parseInt(deliveryTimeMax) : null,
```

**UI section** — add a "Срок доставки (переопределение)" section. Place it as a full-width section below the sale section (and above the save buttons). Use empty-string sentinel for "use brand default" (same pattern as AddNewItemPage):

```tsx
{/* Delivery time override */}
<div className="border border-border/30 rounded-lg p-4 space-y-3">
  <div>
    <h3 className="font-medium text-sm">Срок доставки для этого товара</h3>
    <p className="text-xs text-muted-foreground">
      Оставьте пустым, чтобы использовать настройки бренда
    </p>
  </div>
  <div className="grid grid-cols-2 gap-4">
    <div>
      <Label>Минимальный срок</Label>
      <Select value={deliveryTimeMin} onValueChange={setDeliveryTimeMin}>
        <SelectTrigger className="mt-1">
          <SelectValue placeholder="По умолчанию бренда" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">По умолчанию бренда</SelectItem>
          {DELIVERY_TIME_OPTIONS.map((opt) => (
            <SelectItem key={opt.value} value={String(opt.value)}>
              {opt.label}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
    <div>
      <Label>Максимальный срок</Label>
      <Select value={deliveryTimeMax} onValueChange={setDeliveryTimeMax}>
        <SelectTrigger className="mt-1">
          <SelectValue placeholder="По умолчанию бренда" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="">По умолчанию бренда</SelectItem>
          {DELIVERY_TIME_OPTIONS.map((opt) => (
            <SelectItem key={opt.value} value={String(opt.value)}>
              {opt.label}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  </div>
</div>
```

`Select`, `SelectTrigger`, `SelectValue`, `SelectContent`, `SelectItem` are already imported in the modal.
  </action>
  <verify>cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit 2>&1 | head -20</verify>
  <done>
- TypeScript compiles clean
- Modal has delivery time min/max selects initialized from product.delivery_time_min/max
- Empty string selection sends null in updateProduct payload (clears override → falls back to brand default)
- DELIVERY_TIME_OPTIONS defined locally in the file
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/goldp1/Polka/packages/frontend && npx tsc --noEmit
```
Expect: 0 errors.

Manual test with API running:
1. Open Products tab → click a product
2. Find "Таблица размеров" section — upload an image → thumbnail appears
3. Find "Срок доставки для этого товара" section — select min=3 дня, max=1 неделя
4. Click Save → success toast
5. Reopen the same product modal → sizing table thumbnail shown, delivery selects show the saved values
6. Change delivery selects back to empty → Save → delivery_time_min/max cleared to null in API
</verification>

<success_criteria>
1. TypeScript compiles clean.
2. ProductDetailsModal has a sizing table section with FileInput, preview thumbnail, and remove button.
3. Uploading a sizing table image uses the S3 presigned URL flow (same as general images).
4. ProductDetailsModal has delivery time min/max selects with DELIVERY_TIME_OPTIONS.
5. Selecting empty sends null for delivery_time_min/max (clears per-product override).
6. All five enrichment fields (sale_price, sale_type, sizing_table_image, delivery_time_min, delivery_time_max) are included in the updateProduct payload when saving.
</success_criteria>

<output>
After completion, create `.planning/phases/06-product-enrichment-api-web/06-03-SUMMARY.md` summarizing the state variables added, where each section was placed in the modal JSX, and any deviations from the plan.
</output>
