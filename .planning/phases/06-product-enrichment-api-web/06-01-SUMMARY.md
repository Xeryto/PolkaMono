---
phase: 06-product-enrichment-api-web
plan: "01"
subsystem: api
tags: [fastapi, sqlalchemy, pydantic, alembic, postgres]

requires:
  - phase: 05-brand-profile-restructure
    provides: delivery_time_min/max on Product model and ProductCreateRequest/UpdateRequest

provides:
  - sale_price (Float nullable) and sale_type (String(10) nullable) columns on products table
  - sizing_table_image (String nullable) column on products table
  - Alembic migration 7895696e1a95 adding those three columns
  - product_to_schema exposes all five enrichment fields (delivery_time backfill + three new fields)
  - create_product passes new fields from request to ORM model
  - ProductCreateRequest/UpdateRequest validate sale_price > 0 and sale_type required when sale_price set

affects:
  - 06-02 (sale-setting UI)
  - 06-03 (sizing-table upload UI)
  - any future product read paths in web portal

tech-stack:
  added: []
  patterns:
    - "sale_type enum enforced via Pydantic Field(pattern) rather than DB enum for migration flexibility"
    - "model_validator sale consistency check mirrors delivery_time pattern already in place"

key-files:
  created:
    - packages/api/alembic/versions/7895696e1a95_add_sale_price_and_sizing_table_to_.py
  modified:
    - packages/api/models.py
    - packages/api/schemas.py
    - packages/api/main.py

key-decisions:
  - "[06-01] sale_type validated via Pydantic regex pattern=r'^(percent|exact)$' not DB enum"
  - "[06-01] sale_price validator only in ProductCreateRequest (UpdateRequest reuses model_validator consistency check)"
  - "[06-01] delivery_time_min/max backfilled into product_to_schema — were set on write but never returned"

patterns-established:
  - "New scalar product fields: add to Product model -> schemas Create/Update/Response -> product_to_schema kwargs -> create_product constructor"

requirements-completed:
  - PROD-01
  - PROD-03
  - PROD-04
  - PROD-06

duration: 10min
completed: 2026-02-24
---

# Phase 6 Plan 01: Product Enrichment API Summary

**Three nullable product columns (sale_price, sale_type, sizing_table_image) added to DB + Pydantic + product_to_schema; delivery_time backfilled into API response**

## Performance

- **Duration:** ~10 min
- **Started:** 2026-02-24T06:12:00Z
- **Completed:** 2026-02-24T06:22:47Z
- **Tasks:** 3
- **Files modified:** 4 (models.py, schemas.py, main.py, migration)

## Accomplishments

- Products table extended with `sale_price` (Float), `sale_type` (VARCHAR 10), `sizing_table_image` (TEXT) — all nullable; Alembic migration applied
- Pydantic schemas updated: ProductCreateRequest and ProductUpdateRequest accept all three new fields with validation; Product response schema exposes them
- `product_to_schema()` now returns `delivery_time_min`, `delivery_time_max`, `sale_price`, `sale_type`, `sizing_table_image` — delivery_time was a pre-existing gap

## Task Commits

1. **Task 1: Add columns to Product model** - `067b2e1` (feat)
2. **Task 2: Update Pydantic schemas + run migration** - `8bac9ec` (feat)
3. **Task 3: Update product_to_schema + create_product** - `e06ddcd` (feat)

## Files Created/Modified

- `packages/api/models.py` - Three new nullable columns on Product class
- `packages/api/schemas.py` - sale_price/sale_type/sizing_table_image in Create, Update, and response schemas; sale_price field_validator; sale consistency model_validator
- `packages/api/main.py` - product_to_schema: 5 enrichment fields; create_product: passes new fields to ORM constructor
- `packages/api/alembic/versions/7895696e1a95_add_sale_price_and_sizing_table_to_.py` - Autogenerated migration, applied cleanly

## Decisions Made

- `sale_type` validated via Pydantic `Field(pattern=r"^(percent|exact)$")` rather than a PostgreSQL enum — avoids irreversible DDL
- `sale_price` validator (`> 0`) added only to `ProductCreateRequest`; `ProductUpdateRequest` relies on the model_validator sale consistency check
- `delivery_time_min/max` were already persisted by Phase 5 writes but were silently dropped in `product_to_schema` — backfilled here as a Rule 1 auto-fix

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Backfilled delivery_time_min/max into product_to_schema**
- **Found during:** Task 3 (update product_to_schema)
- **Issue:** Phase 5 added delivery_time fields to Product model and create/update routes but never added them to `product_to_schema`, so GET responses silently omitted them
- **Fix:** Added `delivery_time_min=product.delivery_time_min, delivery_time_max=product.delivery_time_max` to product_to_schema kwargs (explicitly noted in plan as expected)
- **Files modified:** packages/api/main.py
- **Verification:** All imports clean; grep confirms hits in product_to_schema
- **Committed in:** e06ddcd (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (Rule 1 bug — pre-existing gap explicitly called out in plan)
**Impact on plan:** Fix was planned and required. No scope creep.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- `GET /api/v1/brands/products` now returns `sale_price`, `sale_type`, `sizing_table_image`, `delivery_time_min`, `delivery_time_max` for all products (null for existing rows)
- `PUT /api/v1/brands/products/{id}` handles the new fields via existing setattr fallthrough
- Web portal sale-setting UI (06-02) and sizing-table upload UI (06-03) can now be built against this API surface

---
*Phase: 06-product-enrichment-api-web*
*Completed: 2026-02-24*

## Self-Check: PASSED

- FOUND: .planning/phases/06-product-enrichment-api-web/06-01-SUMMARY.md
- FOUND: 067b2e1 (Task 1 commit)
- FOUND: 8bac9ec (Task 2 commit)
- FOUND: e06ddcd (Task 3 commit)
