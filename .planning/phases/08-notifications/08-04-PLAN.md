---
phase: 08-notifications
plan: 04
type: execute
wave: 3
depends_on:
  - 08-01
  - 08-03
files_modified:
  - packages/api/notification_service.py
  - packages/api/main.py
  - packages/frontend/src/pages/Dashboard.tsx
  - packages/frontend/src/components/DashboardSidebar.tsx
  - packages/frontend/src/pages/AdminNotificationsPage.tsx
autonomous: true
requirements:
  - NOTIF-04
  - NOTIF-06

must_haves:
  truths:
    - "When an order status transitions to SHIPPED, the buyer receives an Expo push notification"
    - "Admin can send a manual custom in-app notification to all brands via the brand portal"
    - "Brand bell shows admin-sent notifications alongside order notifications"
  artifacts:
    - path: "packages/api/notification_service.py"
      provides: "send_expo_push_notification(), send_buyer_shipped_notification(), send_admin_broadcast_to_brands()"
      contains: "send_expo_push_notification"
    - path: "packages/api/main.py"
      provides: "POST /api/v1/admin/notifications/send endpoint + SHIPPED hook"
      contains: "admin/notifications/send"
    - path: "packages/frontend/src/pages/AdminNotificationsPage.tsx"
      provides: "Admin UI form to send broadcast notification message to all brands"
      contains: "AdminNotificationsPage"
  key_links:
    - from: "packages/api/main.py"
      to: "packages/api/notification_service.py"
      via: "send_buyer_shipped_notification() called when order transitions to SHIPPED (in update tracking endpoint)"
      pattern: "send_buyer_shipped_notification"
    - from: "packages/api/notification_service.py"
      to: "https://exp.host/--/api/v2/push/send"
      via: "httpx POST to Expo push API with ExponentPushToken"
      pattern: "exp.host.*push.*send"
    - from: "packages/frontend/src/pages/AdminNotificationsPage.tsx"
      to: "packages/frontend/src/services/api.ts"
      via: "POST /api/v1/admin/notifications/send with message body"
      pattern: "admin.*notifications.*send"
---

<objective>
Wire buyer push notifications on SHIPPED status change. Add admin manual broadcast (in-app to brands). Add minimal admin UI inside brand portal.

Purpose: NOTIF-06 (buyer push on shipped) + NOTIF-04 (admin manual notifications to brands).

Scope note on NOTIF-04: NOTIF-04 in REQUIREMENTS.md says "push notifications to buyers, brands, or both." Phase 8 delivers the brand half as in-app only (no Expo push to brands) because brands are web portal users — they have no Expo push tokens. Push to buyers is covered by NOTIF-06 (shipped trigger). Full admin-to-buyer push broadcast is deferred to ADMIN-04 in Phase 9.

Output: send_expo_push_notification() in notification_service, SHIPPED trigger in main.py, admin broadcast endpoint (in-app to brands), AdminNotificationsPage in portal.
</objective>

<execution_context>
@/Users/goldp1/.claude/get-shit-done/workflows/execute-plan.md
@/Users/goldp1/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-notifications/08-01-SUMMARY.md
@.planning/phases/08-notifications/08-03-SUMMARY.md
@packages/api/notification_service.py
@packages/api/main.py
@packages/api/models.py
@packages/frontend/src/pages/Dashboard.tsx
@packages/frontend/src/components/DashboardSidebar.tsx
@packages/frontend/src/services/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expo push delivery + shipped trigger + admin broadcast API</name>
  <files>packages/api/notification_service.py, packages/api/main.py</files>
  <action>
**Step 1 — Add Expo push delivery to notification_service.py:**

Append to `packages/api/notification_service.py`:

```python
import httpx

EXPO_PUSH_URL = "https://exp.host/--/api/v2/push/send"


def send_expo_push_notification(
    push_token: str,
    title: str,
    body: str,
    data: dict | None = None,
) -> None:
    """Send a push notification via Expo Push API. Fire-and-forget — errors are logged not raised."""
    if not push_token or not push_token.startswith("ExponentPushToken"):
        return  # not a valid Expo token
    payload = {
        "to": push_token,
        "title": title,
        "body": body,
        "sound": "default",
        "data": data or {},
    }
    try:
        with httpx.Client(timeout=5.0) as client:
            client.post(EXPO_PUSH_URL, json=payload, headers={"Accept": "application/json"})
    except Exception as exc:
        print(f"notification_service - push failed: {exc}")


def send_buyer_shipped_notification(db: Session, order_id: str, brand_name: str, user_id: str) -> None:
    """Send Expo push to the buyer when their order is shipped."""
    from models import User
    user = db.query(User).filter(User.id == user_id).first()
    if not user or not user.expo_push_token:
        return
    send_expo_push_notification(
        push_token=user.expo_push_token,
        title="Заказ отправлен",
        body=f"Ваш заказ от {brand_name} отправлен",
        data={"order_id": order_id},
    )


def send_admin_broadcast_to_brands(db: Session, message: str) -> None:
    """Create an in-app notification for every active brand.

    Brands are web portal users and have no Expo push tokens — delivery is
    in-app only (bell dropdown). Admin-to-buyer push broadcast is out of scope
    for Phase 8 and handled by ADMIN-04 in Phase 9.
    """
    from models import Brand
    brands = db.query(Brand).filter(Brand.is_inactive == False).all()
    for brand in brands:
        create_notification(
            db=db,
            recipient_type="brand",
            recipient_id=str(brand.id),
            notif_type="admin_custom",
            message=message,
        )
```

**Step 2 — Wire SHIPPED trigger in packages/api/main.py:**

Find the tracking update endpoint (around line 2204 — `"Update tracking number and link for an order"`). It already calls `payment_service.update_order_status(str(order.id), OrderStatus.SHIPPED.value)`. Add the buyer push call immediately after:

```python
# After: payment_service.update_order_status(str(order.id), OrderStatus.SHIPPED.value)
# Add:
# Notify buyer
checkout = db.query(Checkout).filter(Checkout.id == order.checkout_id).first() if order.checkout_id else None
if checkout:
    notification_service.send_buyer_shipped_notification(
        db=db,
        order_id=str(order.id),
        brand_name=order.brand.name if order.brand else "бренда",
        user_id=str(checkout.user_id),
    )
```

Note: Check the Order model for `checkout_id` and `brand` relationship; check Checkout for `user_id`. Inspect models.py around Order/Checkout definitions (lines 421+, 489+) to confirm field names. If Order has a direct `user_id`, use that instead. If Order has `brand_id`, load the brand name via `db.query(Brand).filter(Brand.id == order.brand_id).first()`.

**Step 3 — Add admin broadcast endpoint in packages/api/main.py:**

Add after the existing admin cancel endpoints (search for `"admin/orders"`):

```python
class AdminNotificationSend(BaseModel):
    message: str = Field(..., min_length=1, max_length=500)

@app.post("/api/v1/admin/notifications/send", status_code=204)
def admin_send_notification(
    body: AdminNotificationSend,
    current_user=Depends(get_current_brand_user),
    db: Session = Depends(get_db),
):
    """Admin-only: send a custom in-app notification to all active brands.

    Brands use the web portal (no Expo push tokens). Delivery is in-app only.
    Admin-to-buyer push is out of scope for Phase 8.
    """
    admin_email = getattr(settings, 'ADMIN_EMAIL', None)
    if not admin_email or current_user.auth_account.email != admin_email:
        raise HTTPException(status_code=403, detail="Admin only")
    notification_service.send_admin_broadcast_to_brands(db=db, message=body.message)
    return None
```
  </action>
  <verify>
```bash
# Syntax check:
cd packages/api && source .venv/bin/activate && python3 -c "import notification_service; print('ok')"
cd packages/api && source .venv/bin/activate && python3 -c "import main; print('ok')"
```
  </verify>
  <done>send_expo_push_notification() and send_buyer_shipped_notification() in notification_service.py. SHIPPED hook calls send_buyer_shipped_notification() in tracking update endpoint. POST /api/v1/admin/notifications/send creates in-app notifications for all brands (admin-only). No import errors.</done>
</task>

<task type="auto">
  <name>Task 2: Admin notifications UI in brand portal</name>
  <files>packages/frontend/src/pages/AdminNotificationsPage.tsx, packages/frontend/src/pages/Dashboard.tsx, packages/frontend/src/components/DashboardSidebar.tsx, packages/frontend/src/services/api.ts</files>
  <action>
**Step 1 — Add sendAdminNotification() to packages/frontend/src/services/api.ts:**

```typescript
export async function sendAdminNotification(message: string): Promise<void> {
  const token = localStorage.getItem('authToken');
  const res = await fetch(`${API_BASE_URL}/api/v1/admin/notifications/send`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ message }),
  });
  if (!res.ok && res.status !== 204) throw new Error('Failed to send notification');
}
```

**Step 2 — Create packages/frontend/src/pages/AdminNotificationsPage.tsx:**

Follow the same shadcn/ui + Tailwind pattern used by SecuritySettingsPage.tsx and ProfileSettingsPage.tsx:

```tsx
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";
import { Label } from "@/components/ui/label";
import { sendAdminNotification } from "@/services/api";
import { Bell } from "lucide-react";

export function AdminNotificationsPage() {
  const [message, setMessage] = useState("");
  const [sending, setSending] = useState(false);
  const [sent, setSent] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSend = async () => {
    if (!message.trim()) return;
    setSending(true);
    setError(null);
    setSent(false);
    try {
      await sendAdminNotification(message.trim());
      setSent(true);
      setMessage("");
    } catch {
      setError("Не удалось отправить уведомление.");
    } finally {
      setSending(false);
    }
  };

  return (
    <div className="p-4 sm:p-6 max-w-xl">
      <div className="flex items-center gap-2 mb-6">
        <Bell className="h-5 w-5 text-foreground" />
        <h2 className="text-2xl font-bold text-foreground">Уведомления (Админ)</h2>
      </div>

      <div className="bg-card-custom/40 rounded-xl border border-brown-light/20 p-5 space-y-4">
        <div className="space-y-2">
          <Label htmlFor="notif-message" className="text-sm font-medium text-foreground">
            Сообщение для всех брендов
          </Label>
          <Textarea
            id="notif-message"
            placeholder="Введите текст уведомления..."
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            maxLength={500}
            rows={4}
            className="resize-none bg-background/50 border-brown-light/30 text-foreground placeholder:text-muted-foreground"
          />
          <p className="text-xs text-muted-foreground text-right">{message.length}/500</p>
        </div>

        {error && <p className="text-sm text-red-500">{error}</p>}
        {sent && <p className="text-sm text-green-500">Уведомление отправлено всем брендам.</p>}

        <Button
          onClick={handleSend}
          disabled={sending || !message.trim()}
          className="w-full bg-foreground text-background hover:bg-foreground/90"
        >
          {sending ? "Отправка..." : "Отправить всем брендам"}
        </Button>
      </div>
    </div>
  );
}
```

**Step 3 — Integrate AdminNotificationsPage into Dashboard.tsx:**

In `packages/frontend/src/pages/Dashboard.tsx`:
- Add `'admin-notifications'` to the `DashboardView` type union
- Import `AdminNotificationsPage`
- Add a conditional render for `currentView === 'admin-notifications'`

Update the type:
```typescript
type DashboardView = 'stats' | 'orders' | 'products' | 'add-item' | 'profile' | 'security' | 'admin-notifications';
```

Add render in the main content area (find where other views are conditionally rendered based on `currentView`):
```tsx
{currentView === 'admin-notifications' && <AdminNotificationsPage />}
```

**Step 4 — Add Admin Notifications link to DashboardSidebar.tsx:**

Open DashboardSidebar.tsx and find where nav items are defined. Add an admin-only nav item at the bottom:

```tsx
// Add after existing nav items (security, profile, etc.)
// Check if brand is admin: read from useAuth() context; brand.auth_account?.email === ADMIN_EMAIL
// Since frontend doesn't know ADMIN_EMAIL, check a flag OR just show the item to all brands
// Per the existing admin pattern (ADMIN_EMAIL check is server-side), show the UI to all brands
// and let the API return 403 if non-admin. Keep it simple.

{/* Admin section */}
<SidebarMenuItem>
  <SidebarMenuButton
    isActive={currentView === 'admin-notifications'}
    onClick={() => onViewChange('admin-notifications')}
    className="..."
  >
    <Bell className="h-4 w-4" />
    <span>Рассылка (Админ)</span>
  </SidebarMenuButton>
</SidebarMenuItem>
```

Match the exact className/component pattern used by existing sidebar items in DashboardSidebar.tsx. Read the file first to understand the exact structure (SidebarGroup, SidebarMenuItem, SidebarMenuButton pattern).
  </action>
  <verify>
```bash
cd packages/frontend && npx tsc --noEmit 2>&1 | head -20
# Confirm AdminNotificationsPage is importable and renders
```
  </verify>
  <done>AdminNotificationsPage.tsx exists with form. sendAdminNotification() in api.ts. Dashboard.tsx includes 'admin-notifications' view. DashboardSidebar.tsx has "Рассылка (Админ)" nav item. No TypeScript errors.</done>
</task>

</tasks>

<verification>
1. `python3 -c "import notification_service; print(dir(notification_service))"` shows send_expo_push_notification, send_buyer_shipped_notification, send_admin_broadcast_to_brands
2. `python3 -c "import main; print('ok')"` — no import errors in main.py
3. `npx tsc --noEmit` in packages/frontend — no errors from new files
4. AdminNotificationsPage renders without crash (check browser console)
5. POST /api/v1/admin/notifications/send returns 403 for non-admin brand JWT
</verification>

<success_criteria>
- send_expo_push_notification() sends to Expo push API via httpx (fire-and-forget, errors logged not raised)
- SHIPPED status change triggers send_buyer_shipped_notification() for the buyer (NOTIF-06)
- POST /api/v1/admin/notifications/send creates in-app Notification rows for all active brands (admin-only, 403 for others) — brand delivery is in-app only because brands are web users with no Expo push tokens (NOTIF-04 brand half)
- AdminNotificationsPage.tsx: textarea + send button, success/error feedback
- Dashboard sidebar has "Рассылка (Админ)" item navigating to admin-notifications view
- No TypeScript compilation errors in frontend
</success_criteria>

<output>
After completion, create `.planning/phases/08-notifications/08-04-SUMMARY.md`
</output>
